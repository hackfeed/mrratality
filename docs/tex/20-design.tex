\chapter{Конструкторская часть}

В данном разделе представлены этапы проектирования баз данных.

\section{Проектирование базы данных пользователей}

База данных пользователей будет реализована с использованием СУБД MongoDB. В базе данных будет существовать одна коллекция, хранящая в себе документы с информацией о пользователях. Структура документа, хранящего информацию о пользователе, представлена на рисунке \ref{img:cp_user}.

\img{100mm}{cp_user}{Структура документа \texttt{User}}

Поля документа означают:

\begin{itemize}
	\item \texttt{\_id} -- служебное поле MongoDB, являющееся уникальным идентификатором документа. Не может повторяться в пределах одной коллекции;
	\item \texttt{user\_id} -- уникальный идентификатор пользователя, который будет использоваться для идентификации записей в таблице транзакций. Также будет осуществляться для генерации JWT токенов для JWT-авторизации \cite{jwt};
	\item \texttt{email} -- электронная почта пользователя, используется для авторизации и регистрации;
	\item \texttt{password} -- пароль пользователя, хранящийся в шифрованном виде. Шифрование производится при помощи функции bcrypt \cite{bcrypt};
	\item \texttt{token} -- JWT-токен пользователя;
	\item \texttt{created\_at} -- время создания JWT-токена;
	\item \texttt{updated\_at} -- время обновления JWT-токена;
	\item \texttt{files} -- массив, хранящий названия файлов, загруженных пользователем, в которых хранятся данные для аналитики;
\end{itemize}

\section{Проектирование базы данных транзакций}

База данных транзакций будет реализована с использованием СУБД ClickHouse. В базе данных будет существовать одна таблица, хранящая в себе информацию обо всех транзакциях, и произвольное количество таблиц, хранящих в себе нормированное распределение уплаченных средств за выбранный промежуток времени. Таблицы распределения средств будут создаваться каждый раз, когда пользователь выбирает период для определенного файла, за исключением случая, когда ранее уже был выбран данный период для данного файла. Структура таблиц, хранящих информацию о транзакциях и о распределении уплаченных средств, представлена на рисунке \ref{img:cp_transactions}.

\img{130mm}{cp_transactions}{Структура таблиц \texttt{Invoice} и \texttt{MPP}}

Поля таблицы \texttt{Invoice} означают:

\begin{itemize}
	\item \texttt{user\_id} -- уникальный идентификатор пользователя, который загрузил данные;
	\item \texttt{file\_id} -- название файла, из которого были загружены данные;
	\item \texttt{customer\_id} -- уникальный идентификатор клиента, произведшего транзакцию;
	\item \texttt{period\_start} -- начало расчетного периода;
	\item \texttt{paid\_plan} -- тарифный план;
	\item \texttt{paid\_amount} -- уплаченная сумма за весь расчетный период;
	\item \texttt{period\_end} -- конец расчетного периода;
\end{itemize}

Поля таблицы \texttt{MPP$_i$} означают:

\begin{itemize}
	\item \texttt{userfile\_id} -- уникальный идентификатор, необходимый для нормирования записей таблицы;
	\item \texttt{0X.XXXX} -- месяц из выбранного периода. Количество столбцов таблицы зависит от выбранного пользователем аналитического периода.
\end{itemize}

СУБД ClickHouse позволяет создавать таблицы с разными особенностями обработки и хранения данных за счет применения определенных методов и триггеров к данным. Каждая таблица имеет свой <<движок>>, каждый из которых имеет свои особенности \cite{chengines}.

Таблица \texttt{Invoice} использует движок \texttt{Memory}, позволяющий производить CRUD операции над записями таблицы, при этом хранение данных происходит в оперативной памяти, что обеспечивает быстрое выполнение запросов, но ограничивает в персистентности данных. Для исправления данного недостатка можно использовать движок \texttt{Buffer}, который хранит данные в оперативной памяти, но переодически сбрасывает их на диск, таким образом имея две копии в один момент времени. В случае аварийного отказа базы данных, потеря данных не произойдет.

Таблица \texttt{MPP} использует движок \texttt{SummingMergeTree} из семейства движков \texttt{MergeTree}. Данный движок позволяет производить необходимую нормировку по клиентам, сохраняя в каждый момент времени только одну запись с заданным ключом условия. В данной работе таким ключом является поле \texttt{userfile\_id}. Обнаружив несколько записей с заданным ключом, движок будет суммировать числовые поля записей, имеющих одинаковый ключ. Таким образом без дополнительной обработки можно получить нормированное распределение уплаченных средств.

\section{Проектирование базы данных кэширования}

База данных кэширования будет реализована с использованием СУБД Tarantool. В базе данных будет существовать одна таблица (спейс), хранящая в себе информацию о расчитанном MRR для заданного периода. Первичным ключом будет являться поле, содержащее в себе уникальный идентификатор пользователя, имя файла и заданный период. При повторном запросе данных сначала будет производиться проверка, присутствует ли запись в кэше. В случае, если запись присутствует, запрос к базе данных транзакций производиться не будет и будут возвращены данные из кэша. В противном случае будет произведен запрос к базе данных с транзакциями. Структура спейса, хранящего кэшируюмую информацию, представлена на рисунке \ref{img:cp_cache}.

\img{30mm}{cp_cache}{Структура спейса \texttt{Cache}}

Поля спейса \texttt{Cache} означают:

\begin{itemize}
	\item \texttt{userfileperiod} -- уникальный идентификатор, являющийся первичным ключом;
	\item \texttt{mrr} -- набор пар <<ключ -- значение>>, в которых ключом является компонент MRR (New, Old, Reactivation, Exapnsion, Contraction, Churn, Total), а значением -- его непосредственное значение.
\end{itemize}

Спейс \texttt{Cache} создан на основе движка \texttt{memtx}, хранящего все данные в оперативной памяти \cite{tntengines}. Персистентность данных обеспечивается при помощи ведения журнала транзакций, хранящегося на диске. При аварийном завершении работы базы данных и последующем перезапуске транзакции, записанные в журнал, применяются заново, и база данных становится доступна для использования в том же состоянии, в котором была до момента отказа.

\section*{Вывод}

В данном разделе были представлены этапы проектирования баз данных, рассмотрены особенности используемых СУБД на архитектурном уровне.